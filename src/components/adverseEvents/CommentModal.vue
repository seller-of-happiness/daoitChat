<script setup lang="ts">
/*
* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
*
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
* - –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–≤–µ—Å—Ç–∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
* - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã: –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∏ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏
* - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—è
* - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
* - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–µ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
*/

// –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π Vue –∏ —Å—Ç–æ—Ä–æ–≤ Pinia
import { computed, reactive, watch } from 'vue'
import { useFeedbackStore } from '@/refactoring/modules/feedback/stores/feedbackStore'
import { useApiStore } from '@/refactoring/modules/apiStore/stores/apiStore'
import { useSupportService } from '@/refactoring/modules/supportService/stores/supportService'
import { useCalendarStore } from '@/refactoring/modules/calendar/stores/calendarStore'
import { storeToRefs } from 'pinia'

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â:
// feedbackStore - –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ toast-—Å–æ–æ–±—â–µ–Ω–∏–π
// apiStore - –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const feedbackStore = useFeedbackStore()
const apiStore = useApiStore()
const supportService = useSupportService()
const calendarStore = useCalendarStore()

// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—É—â–µ–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ apiStore
const { currentAdverseEvent } = storeToRefs(apiStore)
// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—É—â–µ–µ –∑–∞—è–≤–∫—É –≤–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Å–ª—É–∂–±—É –∏–∑ supportService
const { currentSupportService } = storeToRefs(supportService)
// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ calendarStore
const { currentCalendarEvent } = storeToRefs(calendarStore)

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ props –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:
// visible - —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å—é –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
// targetField - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–µ–ª–µ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ('participants' –∏–ª–∏ 'location')
// defaultComment - –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)
const props = defineProps<{
    visible: boolean
    targetField?: 'participants' | 'apiStoreLocation' | 'supportStoreLocation' | 'calendarStoreLocation'
    defaultComment?: string
}>()

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:
// update:visible - –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
// closeModal - –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
// onSaved - –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
const emit = defineEmits(['update:visible', 'closeModal', 'onSaved'])

// –í—ã—á–∏—Å–ª—è–µ–º–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è visible
const visible = computed({
    get: () => props.visible,
    set: v => emit('update:visible', v),
})

// –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:
// comment - —Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
const state = reactive({
    comment: props.defaultComment ?? '',
})

// –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º visible, —á—Ç–æ–±—ã —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å comment –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
watch(
    () => props.visible,
    (val) => {
        if (val) {
            state.comment = props.defaultComment ?? ''
        }
    }
)

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ 5-—Å–∏–º–≤–æ–ª—å–Ω–æ–≥–æ ID –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
const createId = () => {
    let id = ''
    let chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
    for (let i = 0; i < 5; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length))
    }
    return id
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
// - –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç targetField —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ª–∏–±–æ –≤ location, –ª–∏–±–æ –≤ participants
// - –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è
function setData() {
    if (!state.comment.trim()) {
        feedbackStore.showToast({
            type: 'error',
            title: '–û—à–∏–±–∫–∞!',
            message: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ',
            time: 3000,
        })
        return
    }

    const comment = state.comment.trim()

    if (props.targetField === 'apiStoreLocation') { // üîÑ
        currentAdverseEvent.value.location = comment
        currentAdverseEvent.value.block = null
        currentAdverseEvent.value.floor = null
        currentAdverseEvent.value.room = null
    } else if (props.targetField === 'supportStoreLocation') {
        currentSupportService.value.location = comment
        currentSupportService.value.block = null
        currentSupportService.value.floor = null
        currentSupportService.value.room = null
    } else if (props.targetField === 'calendarStoreLocation') { // üîÑ
        currentCalendarEvent.value.location = comment
        currentCalendarEvent.value.block = null
        currentCalendarEvent.value.floor = null
        currentCalendarEvent.value.room = null
    } else {
        if (!Array.isArray(currentAdverseEvent.value.participants)) {
            currentAdverseEvent.value.participants = []
        }
        currentAdverseEvent.value.participants.push({
            full_name: '–î—Ä—É–≥–æ–µ',
            comment: comment,
            key: createId(),
            birth_date: null,
            phone_number: '',
            participant_type: 'other',
        })
    }

    emit('onSaved', comment)
    emit('update:visible', false)
    emit('closeModal')
}
</script>

<template>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    <Dialog
        v-model:visible="visible"
        header="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
        :modal="true"
        :style="{ width: '1000px', 'min-height': '600px' }"
    >
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ -->
        <div class="grid grid-cols-12 gap-4">
            <div class="col-span-full">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–ª—è (–º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç targetField) -->
                <label for="comment" class="block font-bold mb-3">
                    {{
                        props.targetField === 'apiStoreLocation' ||
                        props.targetField === 'supportStoreLocation' ||
                        props.targetField === 'calendarStoreLocation'
                            ? '–û–ø–∏—à–∏—Ç–µ –º–µ—Å—Ç–æ'
                            : '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'
                    }}
                </label>
                <!-- –ü–æ–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ -->
                <Textarea id="comment" v-model="state.comment" rows="20" cols="30" class="w-full" />
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ -->
        <div class="flex justify-end gap-3 dialog-actions">
            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã -->
            <Button label="–û—Ç–º–µ–Ω–∏—Ç—å" icon="pi pi-times" text @click="emit('closeModal')" />
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
            <Button label="–í—ã–±—Ä–∞—Ç—å" icon="pi pi-check" @click="setData" />
        </div>
    </Dialog>
</template>

<!-- –°—Ç–∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ø—É—Å—Ç—ã–µ) -->
<style lang="scss" scoped></style>
